# .gitlab-ci.yml
stages:
  - release

variables:
  APP_NAME: "duo-chat"
  VERSION: "0.1.0"

release:
  stage: release
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - apk add --no-cache tar
    - echo "Creating source code bundle for version $CI_COMMIT_TAG"
    - tar -czf "${APP_NAME}-macos-v${CI_COMMIT_TAG}.tar.gz" --exclude=".git" --exclude="build" --exclude="${APP_NAME}-macos-v${CI_COMMIT_TAG}.tar.gz" .
    - echo "Creating release..."
    - |
      apk add --no-cache curl jq
      RELEASE_NOTES="## ðŸš€ Release $CI_COMMIT_TAG\n\n**Duo Chat** - GitLab AI Chat Client for macOS\n\n### ðŸ“¥ Source Code\n- **[Source Code](${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${APP_NAME}/${CI_COMMIT_TAG}/${APP_NAME}-macos-v${CI_COMMIT_TAG}.tar.gz)**\n\n---\nBuilt from commit: \`$CI_COMMIT_SHORT_SHA\`  \nBuild date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
      curl --request POST \
           --header "JOB-TOKEN: $CI_JOB_TOKEN" \
           --header "Content-Type: application/json" \
           --data "{
             \"name\": \"Duo Chat $CI_COMMIT_TAG\",
             \"tag_name\": \"$CI_COMMIT_TAG\",
             \"description\": $(echo \"$RELEASE_NOTES\" | jq -Rs .),\n             \"assets\": {\n               \"links\": [{\n                 \"name\": \"${APP_NAME}-macos-v${CI_COMMIT_TAG}.tar.gz\",\n                 \"url\": \"${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${APP_NAME}/${CI_COMMIT_TAG}/${APP_NAME}-macos-v${CI_COMMIT_TAG}.tar.gz\"\n               }]\n             }\n           }" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
  artifacts:
    paths:
      - "${APP_NAME}-macos-v${CI_COMMIT_TAG}.tar.gz"